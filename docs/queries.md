# Опис сценаріїв роботи з базою даних

Цей документ описує основні сценарії роботи з сутностями системи бібліотеки: створення, оновлення, видалення та вибірки даних, а також складні аналітичні запити.

---

## 1. Комплексний сценарій створення сутностей

**Реалізовано в:** `LoanService.issueBook(Long bookId, Long readerId)`

### Опис

Сценарій оформлення видачі книги. Це атомарна операція, яка пов'язує **три сутності**:

* `Loan`
* `Book`
* `Reader`

### Транзакційність

Метод позначений анотацією `@Transactional`. Якщо будь-яка з операцій у межах транзакції завершиться помилкою (наприклад, не буде знайдено читача), створення запису `Loan` **не відбудеться**, що гарантує цілісність даних.

### Валідація

Перед створенням запису виконується перевірка існування:

* книги
* читача

Перевірка реалізована за допомогою `.orElseThrow()`.

### Обробка помилок

У разі відсутності необхідної сутності генерується `RuntimeException`, що автоматично призводить до **ROLLBACK** транзакції.

### Повернення даних

Метод повертає **повністю ініціалізований об'єкт `Loan`** з усіма зв'язаними сутностями.

---

## 2. Сценарій оновлення сутностей

**Реалізовано в:** `BookService.updateBookTitle(Long id, String newTitle)`

### Опис

Оновлення назви книги з урахуванням її поточного стану в базі даних.

### Логіка роботи

1. Виконується `SELECT` для перевірки існування книги.
2. Змінюється поле `title`.
3. Дані зберігаються через виклик `.save()` (операція `UPDATE`).

### Повідомлення про помилки

Якщо книгу з переданим `id` не знайдено, користувач отримує зрозуміле повідомлення:

> **"Книгу з ID ... не знайдено"**

---

## 3. Сценарій видалення сутностей

**Реалізовано в:** `ReaderService`

У проєкті продемонстровано **два підходи** до видалення даних.

### М'яке видалення (Soft Delete)

**Метод:** `softDeleteReader`

* Запис **не видаляється фізично** з бази даних
* Встановлюється прапорець `isDeleted = true`
* Фіксується час видалення у полі `deletedAt`

 Переваги:

* Збереження історії видач книг
* Можливість подальшої аналітики та аудиту

### Жорстке видалення (Hard Delete)

**Метод:** `hardDeleteReader`

* Використовується стандартний SQL `DELETE`
* Цілісність даних контролюється зовнішніми ключами (`Foreign Keys`) у таблиці `loans`

---

## 4. Прості SELECT-запити

**Реалізовано в:** `BookRepository`, `ReaderRepository`

### Фільтрація та пошук

**Метод:** `findByTitleContainingIgnoreCase`

* Використовує оператор `LIKE`
* Підтримує пошук без урахування регістру
* Забезпечує гнучкий пошук книг за назвою

### Фільтрація активних записів

**Метод:** `findAllActiveReaders`

* Повертає лише активних читачів
* Виключає записи з `isDeleted = true`

---

## 5. Складні аналітичні запити

**Реалізовано в:** `ReaderRepository.findTop3ReadersByBorrowCount()`

### Використані технології

* `CTE` (Common Table Expressions)
* Window Functions (`DENSE_RANK`)
* **4 JOIN-операції** між таблицями

### Бізнес-цінність

Запит дозволяє:

* визначити **найбільш лояльних читачів бібліотеки**;
* ранжувати їх за кількістю взятих книг;
* отримати результат **незалежно від категорій книг**.

Це може бути використано для:

* аналітики
* програм лояльності
* прийняття управлінських рішень
